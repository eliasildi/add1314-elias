# SOLO FALTA COLOCAR CAPTURAS DE JOEL

# Y LA ULTIMA RESTRICCION Y REVISAR LO DEL PASO 3 DE LOS COLORES
<chapter>
	<title>A3 SSH</title>
	<para>Esta práctica constará de los siguientes apartados:
		<itemizedlist>
                <listitem>0. Introducción.</listitem>
                <listitem>1. Preparativos.</listitem>
                <listitem>2. Instalación básica.</listitem>
                <listitem>3. Personalización del prompt Bash</listitem>
                <listitem>4. Autenticación mediante claves públicas</listitem>
                <listitem>5. Uso de SSH como túnel para X</listitem>
                <listitem>6. Aplicaciones Windows nativas</listitem>
                <listitem>7. Restricciones de uso</listitem>
                <listitem>8. Resumen</listitem>
        </itemizedlist>
	</para>
	
<sect1>

		<title>0. Introducción.</title>
		<para>Para realizar esta práctica vamos a realizar dos esquemas iguales, servidor SSH en XUbuntu
		con dos clientes (Windows 7 y OpenSuse):
		<itemizedlist>
			<listitem>S1. Servidor SSH XUbuntu.</listitem>
			<listitem>C1. OpenSuse.</listitem>
			<listitem>C2. Windows 7.</listitem>
		</itemizedlist>
		</para>
</sect1>

<sect2>
		<title>1. Preparativos.</title>
		
		<section>
			<title>Configuracion del Servidor SSH XUbuntu</title>
			
			
			<section>
				<title>IP, HOST, Nombres de equipo, usuarios.</title>
				<para>
				<figure id="001">
				<title>Usuarios.</title>
				<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/01.s.usuarios.png" format="PNG" align="center" scale="70" />
				</imageobject>
				</mediaobject>
				</figure>


				<figure id="002">
				<title>IPs Servidor.</title>
				<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/01sIPstatic.png" format="PNG" align="center" scale="70" />
				</imageobject>
				</mediaobject>
				</figure>


				<figure id="003">
				<title>Nombre equipo.</title>
				<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/01s.etc-hosts.png" format="PNG" align="center" scale="70" />
				</imageobject>
				</mediaobject>
				</figure>
				
				
				</para>
			</section>
		</section>
		
		<section>
			<title>Clientes.</title>
			<para>Client1 será OpenSuse y el Client2 Windows 7</para>
			<section>
				<title>Opensuse.</title>		
				<section>
					<title>Instalación.</title>
					<para>Utilizamos una OVA en la que ya está instalado.</para>
				</section>
			
			
	#*************************************** revisar capturas **************************************
				<section>
					<title>IP, HOST, Nombres de equipo, usuarios.</title>
					<para>

					<figure id="004">
			<title>Config. de Opensuse </title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/JOEL.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
	
					</para>
				</section>
				
				
			</section>
			
			<section>
				<title>Windows 7</title>
				<para>Tendremos que instalar un software para poder utilizar ssh, y modificaremos el archivo C:\Windows\System32\drivers\etc\hosts</para>
				
				<section>
					<title>Instalación.</title>
					<para>Instalaremos el PuTTY
			<figure id="004">
			<title>Putty instalado</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/c1putty.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
					
					</para>
				</section>
			
				<section>
					<title>IP, HOST.</title>
					<para>
					
			<figure id="005">
			<title>IP Win7</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/c1IP.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>

			<figure id="006">
			<title>Archivo Hosts</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/c1hosts.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
					</para>
				</section>			
			</section>
		</section>
</sect2>


<sect3>
		<title>2. Instalación Básica.</title>
		
		<para>Instalamos el openssh-server:
			<figure id="007">
			<title>Instalar SSH.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/01sopenssh-server.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		</para>
			<title>Comprobaciones y generación de claves.</title>
			<para>Iniciamos el servicio ssh:</para>
			<figure id="008">
			<title>Iniciar ssh.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/2sverificar.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			<para>Nos conectamos desde Windows con PuTTy:</para>
			<figure id="009">
			<title>Primera coexion ssh.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/CAPTURA-JOEL.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<figure id="010">
			<title>Conectado con Putty.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/2c1remoteuser1.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		<para>En Windows no encontramos el fichero known_hosts. Crearemos nuevas claves en el servidor con el comando ssh-keygen:</para>

			<figure id="011">
			<title>Generar Nuevas Claves.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/2sssh-keygen.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<para>Reiniciamos el servicio:</para>
			<figure id="012">
			<title>Reiniciar SSH.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/2sreiniciarservicio.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
	

			<para>Volvemos a conectarnos desde los clientes, usando el usuario remoteuser2 y remoteuser1. ¿Qué sucede?:</para>
			<figure id="012">
			<title>Reconectar con SSH.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/CAPTURAJOELRECONECTAR.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>	
		
</sect3>


<sect4>
		<title>3. Personalización del prompt Bash.</title>
		<para>En cada usuario hay que modificar el fichero .bashrc y agregar unas lineas al final:</para>
			<figure id="013">
			<title>Fichero .bashrc.</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/3bashhrc.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>

			<para>Probamos:</para>
			<figure id="013">
			<title>Ejecutar ssh y ver color del bash</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/3bashhrc2.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			<para>Nos ha dado un fallo, lo revisaremos mas adelante.</para>
</sect4>

# REVISAR CAPTURAS DEL SECTION 5  ************************************************

<sect5>
		<title>4. Autenticación mediante claves públicas</title>
		<para>Proceso: JOEL LA HIZO
		
		<figure id="555">
			<title>Autenticación</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/JOEL.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<figure id="666">
			<title>Autenticación</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/JOEL.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		
		
		</para>
		
</sect5>

# REVISAR CAPTURAS DEL SECTION 6  ************************************************

<sect6>
		<title>5. Uso de SSH como túnel para X</title>
		<para>Proceso: JOEL LA HIZO
				<figure id="555">
			<title>Autenticación</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/JOEL.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<figure id="666">
			<title>Autenticación</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/JOEL.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		
		
		
		
		
		
		</para>
		
</sect6>

<sect7>
		<title>6. Aplicaciones Windows nativas</title>
		<para>Instalamos Wine</para>
		<figure id="014">
		<title>Wine</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/6swine.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		<para>Instalar aplicación (APP2) de Windows en el servidor SSH usando el emulador Wine. Elegimos el
		CCleaner porque seguramente al instalar el Wine nos creará una "instalación virtual de windows" con
		sus registros y archivos temporales que podremos limpiar con el Ccleaner.</para>
			<figure id="015">
			<title>App con Wine</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/6swineapp.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		
		<para>Comprobar el funcionamiento de APP2 en ssh-server..</para>
			<figure id="016">
			<title>Probar Wine en server</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/6swineappprobarenserver.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<para>Comprobar el funcionamiento de APP2 desde Cliente..</para>
			<figure id="017">
			<title>Probar Wine en cliente</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/CCLEANER.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<figure id="018">
			<title>Ccleaner ssh wine</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/CCLEANER2.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			<figure id="018">
			<title>Duda: rm -fr desde cliente en el servidor?</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/ccleaner3rm-rfxanxanxannnn.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
		
		
		
		
</sect7>

# REVISAR CAPTURAS DEL SECTION 8  7.3 y 7.4************************************************

<sect8>
		<title>7. Restricciones de uso</title>
		<para>Vamos a modificar los usuarios del servidor SSH para añadir algunas restricciones de uso del servicio.</para>
		
		<section>
			<title>7.1 Sin restricción (tipo 1)</title>
			<para>Usuario sin restricciones, el usuario remoteuser1, podrá conectarse vía SSH sin restricciones.</para>
			<figure id="019">
			<title>Conectando</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/0.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
			
		</section>
		
		<section>
			<title>7.2 Restricción total (tipo 2)</title>
			<para>Modificamos el archivo "/etc/ssh/sshd_config" añadiendo la denegación, para ello añadiremos
			una línea al final "AllowUsers remoteuser1 remoteuser2" esos serían los permitidos.</para>
			<figure id="020">
			<title>Restricción 2</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/7.2-fichero.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>		
		</section>
		
		<section>
			<title>7.3 Restricción temporal (tipo 3)</title>
			<para>Crearemos un script que "bloquee" a los usuarios, irá en "/usr/local/bin/" pero lo lanzaremos manualmente, cuando se lanza la orden
			de bloquear se modificara el archivo "sshd_config.system" quitando los usuarios que no queremos, y cuando se lanza
			la orden de permitir se añadiran los usuarios al fichero. (o sustituiremos el fichero completo teniendo dos para cada caso.</para>
			
			<figure id="021">
			<title>Restricción 3</title>
			<mediaobject>
				<imageobject>
					<imagedata fileref="img/t1a3/JOEEEL-SCRIP2.png" format="PNG" align="center" scale="70" />
				</imageobject>
			</mediaobject>
			</figure>
			
		</section>
		
		<section>
			<title>7.4 Restricción sobre aplicaciones (tipo 4) EN CLASE</title>
			<para></para>
				
		
		
</sect8>


</chapter>
